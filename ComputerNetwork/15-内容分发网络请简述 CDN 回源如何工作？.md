# CDN 是什么?

* 和域名系统类似，内容分发网络（Content Dilivery Network，CDN）是一个专门用来分发内容的分布式应用。
* 无状态，或者说是静态的


* 事实上,很多大型的应用,会把DNS解析作为一种负载均衡的手段。
* 当用户请求一个网站的时候,会从该网站提供的智能DNS中获取网站的IP。
* 例如当你请求拉钩的时候,具体连接到哪个拉钩的IP,是由拉钩使用的智能DNS服务决定的。
* 域名系统允许网站自己为自己的产品提供DNS解析。


![CDN的智能DNS](https://s0.lgstatic.com/i/image6/M00/41/EE/CioPOWCvAPCAKWMAAAM_tmZAhpc658.png)

* 当用户请求一个静态资源的时候，首先会触发域名系统的解析。域名系统会将解析的责任交由 CDN 提供商来处理，CDN 的智能 DNS 服务会帮助用户选择离自己距离最近的节点，返回这个节点的 A（或 AAAA）记录。然后客户端会向 CDN 的资源节点发起请求，最终获得资源。

* 在上面整个过程当中，CDN 的智能 DNS 还充当了负载均衡的作用。如果一个节点压力过大，则可以将流量导向其他的节点。


# 回源

![CDN回源](https://s0.lgstatic.com/i/image6/M01/41/89/Cgp9HWCsuLeABoBAAAJfmJcMOc0952.png)
* 整个过程是 4 个层级。用户请求静态资源通常用自己的域名（防止跨域和一些安全问题）。为了让用户请求的是自己的网站，而使用的是 CDN 的服务，这里会使用 CNAME 让自己的域名作为 CDN 域名的一个别名。当请求到 CDN 服务的时候，会首先由 CDN 的 DNS 服务帮助用户选择一个最优的节点，这个 DNS 服务还充当了负载均衡的作用。接下来，用户开始向 CDN 节点请求资源。如果这个时候资源已经过期或者还没有在 CDN 节点上，就会从源站读取数据，这个步骤称为CDN 的回源。

* 另一方面，CDN 上缓存的资源通常也会伴随失效时间的设置，当失效之后同样会触发回源。另一种情况是可以通过开放的 API 或者 CDN 管理后台直接删除缓存（让资源失效），这个操作结束后，同样会触发回源。


* CDN 回源有 3 种情况，一种是 CDN 节点没有对应资源时主动到源站获取资源；另一种是缓存失效后，CDN 节点到源站获取资源；还有一种情况是在 CDN 管理后台或者使用开放接口主动刷新触发回源。
