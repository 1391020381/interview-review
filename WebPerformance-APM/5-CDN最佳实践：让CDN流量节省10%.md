# CDN影响体验的因素主要有5类:
1. CDN服务器所在地理位置
2. CDN缓存配置
    - 通过调整CDN对应域名的HTTP请求头 响应头 基于 强制缓存 协商缓存来实现
    - 强制缓存
        - Cache-Control: public, max-age= 60 48 0
    - 协商缓存
3. CDN域名导致的跨域问题
    - 配置许多复杂、特殊的跨域头
    - 额外支持OPTIONS方法的预检请求，对网络带宽、流量资源也有额外的开销。
    - 避免加载跨域资源
4. CDN所使用的压缩算法
    - Accept-Encoding: br;q= 1.0,gzip;q= 0.8,*;q=0.1
    - CDN服务器会通过响应头Content-Encoding: br来标注响应使用的是哪一种算法，br即表明服务器响应的静态资源经过了Brotil压缩算法处理。
5. CDN服务器HTTP协议版本
    - http0.9 
    - http1.0
    - http1.1
    - http2.0
    - http3.0

# CDN配置最佳是实践
1. 选择临近用户的CDN加速区域
    - geoip-lite NPM包基于用户请求的IP地址获取用户所在地域，再搭配上文提到的prom-client && Grafana来进行统计和数据可视化。
2. 配置最长缓存时间
    - 现代架构的前端应用工程一般利用`文件重命名`的方式来实现版本更新，也就是在静态资源文件名中添加`哈希字符串`作为版本号，部署上线时更新文件名中的哈希字符串
    - 基于这种部署上线方式，我们完全可以把CDN上资源的缓存时间设置为固定的最大值，来提高缓存效果

3. 让CDN域名符合同源策略
    - 同源CDN域名作为静态资源路径，就能避免上述配置复杂跨域头的痛苦  youtube
    - oss -> cdn
4. 选择先进的Brotli压缩算法
    - 通常来说 Brotli 算法的压缩率比其他 2 种更高，用 Brotli 代替 Gzip 预计可以减少约 10% 的CDN流量开销。
5. 使用新版本HTTP协议

6. 评估

# CDN对体验的影响因素
## CDN服务器所在位置
* CDN本质上也是一台台服务器,这些服务器距离用户物理距离的远近,对连接延迟 响应速度都有显著影响。
## CDN缓存配置
    - 强制缓存
    - 协商缓存
* CDN的最佳用法是文件上传后不再覆盖更新,这样能最大限度的利用CDN的缓存能力。而且CDN往往下载流量较多,较贵,上传流量较少 较便宜。
* 现代架构的前端应用工程一般利用 文件重命名的方式 实现版本更新,也就是在静态资源文件名中添加哈希字符串作为版本号,部署上线时更新文件名中哈希字符串,而从实现版本更新。 

* 基于这种部署上线方式,我们完全可以把CDN上资源的缓存时间设置为固定的最大值,来提高缓存效果。  即 31536000  365天。
## CDN域名导致的跨域问题    
## 压缩算法
* gzip 最广泛使用的压缩算法,其压缩和速度都是中等的.由于它的普及度较高,所以它在几乎所有的Web服务器和浏览器上都得支持。
* deflate  它其实是 gzip的基础,差异不大。 而 gzip更为普及。
* brotli br 是 Google开发的一种新的算法,在最近几年逐渐得到广泛的应用。
## CDN服务器HTTP协议版本。
1. HTTP/0.9
* 只有GET方法 仅支持传输HTML内容,没有实现HTTP请求头和请求体。仅支持纯文吧信息。
2. HTTP1.0
* 引入请求 响应 以及状态码等诸多基础概念 
* 引入Content-Type 响应头 支持图片等更多类型的响应。
3. HTTP/1.1
* keep-alive 长连接  支持在一个TCP连接上传送多个HTTP请求和响应,减少了建立连接和关闭连接的消耗和延迟。
* 通过Host字段 支持虚拟主机 允许多个域名共用同一个IP地址。
* 新的缓存机制 Etag If-None-Match, Cache-Control等专用头部。
* 新增了 OPTIONS HEAD PUT PATCH DELETE 等一批新的HTTP方法,以及 307永久重定向等一批新的HTTP状态码。
4. HTTP/2
- 多路复用
    - 同域名下所有通道都在单个TCP连接上完成,消除了因创建多个TCP连接而带来的延时和内存消耗。
    - 解决了HTTP层队列头阻塞问题 (TCP层的队列阻塞问题仍然存在)
    - 单个连接上可以并行交错的请求和响应,相互之间不干扰。
- 服务端推送
    - 建立链接后，即使还没有收到浏览器的请求，服务器也可以主动把各种类源推送给浏览器。 
- 头部压缩
    - 将有大量重复内容的HTTP请求响应头进行压缩 节省网络流量。
- 全局基于二进制格式传输
    - 此前的HTTP/1.1版本，头部必须是文本格式，数据体支持文本、二进制两种格式。HTTP/2进一步全面支持二进制格式，以及基于二进制数据分帧，从客户端乱序发送，到服务端再按帧内数据排序组装
5. HTTP/3   QUIC
* 基于UDP协议实现 减少了连接延迟 避免了TCP三次握手四次挥手的开销。避免网络环境变化时需要重新连接的问题,优化了移动设备的连接性能。
* 囊括TLS协议  更快的实现TLS握手 进一步减少往返延迟时间

* CDN使用的HTTP协议版本,对流量开销 加载耗时等用户体验相关指标,都会有显著优化效果。也是我们优化的主要目标之一。
* 如果是类似 springboot2+  server.http2.enabled = true  Tomcat server.http2.enabled=true
server.tomcat.protocol=org.apache.coyote.http11.Http11AprProtocol



